generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // o "mysql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * EMPRESA / ESTRUCTURA BASE
 * =========================
 */
model Empresa {
  id             String    @id @default(cuid())
  nombre         String
  rut            String?   @db.VarChar(40)
  correo         String?
  telefono       String?
  activa         Boolean   @default(true)
  creada_en      DateTime  @default(now())
  actualizada_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  usuarios    Usuario[]
  clientes    Cliente[]
  proveedores Proveedor[]
  productos   Producto[]
  proyectos   Proyecto[]
  Cotizacion  Cotizacion[]
  Compra      Compra[]
  auditLogs   AuditLog[]

  // üëá previsi√≥n
  afpConfigs   AFPConfig[]
  saludConfigs SaludConfig[]

  // üëá HH por empleado (resultado del Excel + c√°lculos)
  hhEmpleados HHEmpleado[]

    cifs CIF[]   // ‚úÖ lado inverso


  // üëá cat√°logos admin (por empresa)
  tipoItems   TipoItem[]
  tipoDias    TipoDia[]
  unidadItems UnidadItem[]
}

/**
 * =========================
 * ROLES DE USUARIO
 * =========================
 */
model RolUsuario {
  id             String    @id @default(cuid())
  nombre         String    @unique
  codigo         String?   @unique
  descripcion    String?
  orden          Int?
  activo         Boolean   @default(true)
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  usuarios Usuario[]
}

/**
 * =========================
 * USUARIOS / RRHH
 * =========================
 */
model Usuario {
  id         String     @id @default(cuid())
  empresa_id String
  empresa    Empresa    @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  rol_id     String
  rol        RolUsuario @relation(fields: [rol_id], references: [id], onDelete: Cascade)

  nombre     String
  correo     String
  contrasena String

  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  // ‚úÖ inversa de Empleado.usuario
  empleado Empleado?

  // ‚úÖ inversa de Rendicion.revisada_por
  rendiciones_revisadas Rendicion[]

  // ‚úÖ inversa de AuditLog.usuario
  auditLogs AuditLog[]

  // ‚úÖ inversa de Cotizacion.vendedor
  cotizaciones_creadas Cotizacion[] @relation("CotizacionVendedor")

  @@unique([correo, eliminado])
}

model Empleado {
  id         String   @id @default(cuid())
  usuario_id String?  @unique
  usuario    Usuario? @relation(fields: [usuario_id], references: [id], onDelete: SetNull)

  // üëá para matchear con Excel
  rut String? @db.VarChar(40)

  cargo          String?
  telefono       String?
  fecha_ingreso  DateTime?
  sueldo_base    Int?
  activo         Boolean   @default(true)
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  // previsi√≥n
  afp_id String?
  afp    AFPConfig? @relation(fields: [afp_id], references: [id], onDelete: SetNull)

  salud_id String?
  salud    SaludConfig? @relation(fields: [salud_id], references: [id], onDelete: SetNull)

  Rendicion Rendicion[]
  proyectos ProyectoMiembro[]

  // Responsable principal de tareas
  tareas Tarea[]

  // Responsable de subtareas
  detalles TareaDetalle[] @relation("EmpleadoTareaDetalle")

  // üëá HH ya calculadas por periodo (derivado del Excel)
  hhRegistros   HHEmpleado[]
  detalleVentas detalleVenta[]

  @@index([afp_id])
  @@index([salud_id])
}

model AFPConfig {
  id         String  @id @default(cuid())
  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  nombre String
  codigo String? @unique
  tasa   Float

  activo         Boolean  @default(true)
  creado_en      DateTime @default(now())
  actualizado_en DateTime @updatedAt

  empleados Empleado[]

  @@index([empresa_id])
}

model SaludConfig {
  id         String  @id @default(cuid())
  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  tipo   String
  nombre String
  tasa   Float

  activo         Boolean  @default(true)
  creado_en      DateTime @default(now())
  actualizado_en DateTime @updatedAt

  empleados Empleado[]

  @@index([empresa_id])
}

/**
 * =========================
 * CLIENTES / PROVEEDORES
 * =========================
 */
model Cliente {
  id             String    @id @default(cuid())
  empresa_id     String
  empresa        Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  nombre         String
  rut            String?   @db.VarChar(40)
  correo         String?
  telefono       String?
  notas          String?
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  cotizaciones Cotizacion[]

  @@unique([correo, eliminado])
  @@index([empresa_id])
}

model Proveedor {
  id             String    @id @default(cuid())
  empresa_id     String
  empresa        Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  nombre         String
  rut            String?   @db.VarChar(40)
  correo         String?
  telefono       String?
  notas          String?
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  compras     Compra[]
  compraItems CompraItem[]

  @@unique([correo, eliminado])
  @@index([empresa_id])
}

/**
 * =========================
 * PRODUCTOS
 * =========================
 */
model Producto {
  id             String    @id @default(cuid())
  empresa_id     String
  empresa        Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  nombre         String
  sku            String?
  precio         Float
  stock          Int       @default(0)
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  //cotizaciones CotizacionItem[]
  compras CompraItem[]

  @@unique([sku, eliminado])
  @@index([empresa_id])
}

/**
 * =========================
 * PROYECTOS
 * =========================
 */
model Proyecto {
  id             String    @id @default(cuid())
  empresa_id     String
  empresa        Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  nombre         String
  descripcion    String?
  presupuesto    Float?
  estado         String    @default("activo")
  creada_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  cotizaciones Cotizacion[]
  compras      Compra[]
  rendiciones  Rendicion[]

  tareas   Tarea[]
  miembros ProyectoMiembro[]

  @@index([empresa_id])
}

model ProyectoMiembro {
  id          String   @id @default(cuid())
  proyecto_id String
  empleado_id String
  rol         String?
  creado_en   DateTime @default(now())

  proyecto Proyecto @relation(fields: [proyecto_id], references: [id], onDelete: Cascade)
  empleado Empleado @relation(fields: [empleado_id], references: [id], onDelete: Cascade)

  @@unique([proyecto_id, empleado_id])
  @@index([empleado_id])
}

/**
 * =========================
 * TAREAS (Planificaci√≥n/Gantt)
 * =========================
 */
model Tarea {
  id          String   @id @default(cuid())
  proyecto_id String
  proyecto    Proyecto @relation(fields: [proyecto_id], references: [id], onDelete: Cascade)

  nombre         String
  descripcion    String?
  responsable_id String?
  responsable    Empleado? @relation(fields: [responsable_id], references: [id], onDelete: SetNull)

  prioridad Int?
  estado    String  @default("pendiente")
  avance    Int     @default(0)
  es_hito   Boolean @default(false)
  orden     Int?

  fecha_inicio_plan DateTime
  fecha_fin_plan    DateTime
  dias_plan         Int?

  fecha_inicio_real DateTime?
  fecha_fin_real    DateTime?
  dias_reales       Int?

  total_dias_plan    Int?
  total_dias_reales  Int?
  total_horas_plan   Float?
  total_horas_reales Float?
  total_costo_plan   Float?
  total_costo_real   Float?
  total_responsables Int?

  source           String  @default("MANUAL")
  jira_key         String?
  jira_tipo        String?
  jira_estado      String?
  jira_sprint      String?
  jira_issue_color String?

  parent_id String?
  parent    Tarea?  @relation("TareaParent", fields: [parent_id], references: [id], onDelete: SetNull)
  children  Tarea[] @relation("TareaParent")

  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  dependencias TareaDependencia[] @relation("TareaDependencias")
  sucesoras    TareaDependencia[] @relation("TareaPredecesoras")

  detalles TareaDetalle[]

  dias_desviacion Int?

  @@unique([proyecto_id, jira_key])
  @@index([proyecto_id])
  @@index([responsable_id])
  @@index([estado])
}

model TareaDetalle {
  id       String @id @default(cuid())
  tarea_id String
  tarea    Tarea  @relation(fields: [tarea_id], references: [id], onDelete: Cascade)

  titulo      String
  descripcion String?

  responsable_id String?
  responsable    Empleado? @relation("EmpleadoTareaDetalle", fields: [responsable_id], references: [id], onDelete: SetNull)

  estado String @default("pendiente")
  avance Int    @default(0)

  fecha_inicio_plan DateTime
  fecha_fin_plan    DateTime
  dias_plan         Int

  fecha_inicio_real DateTime?
  fecha_fin_real    DateTime?
  dias_reales       Int?

  horas_plan Float?
  horas_real Float?

  valor_hora Float?
  costo_plan Float?
  costo_real Float?

  dias_desviacion Int?

  source           String  @default("MANUAL")
  jira_key         String?
  jira_tipo        String?
  jira_estado      String?
  jira_sprint      String?
  jira_issue_color String?

  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  @@unique([tarea_id, jira_key])
}

model TareaDependencia {
  id             String  @id @default(cuid())
  tarea_id       String
  predecesora_id String
  tipo           String?

  tarea       Tarea @relation("TareaDependencias", fields: [tarea_id], references: [id], onDelete: Cascade)
  predecesora Tarea @relation("TareaPredecesoras", fields: [predecesora_id], references: [id], onDelete: Cascade)

  @@unique([tarea_id, predecesora_id])
  @@index([predecesora_id])
}

/**
 * =========================
 * COTIZACIONES
 * =========================
 */
enum EstadoCotizacion {
  COTIZACION
  ORDEN_VENTA
  FACTURADA
  PAGADA
}

/**
 * Cotizaci√≥n principal:
 * - cliente obligatorio
 * - proyecto opcional (se asigna despu√©s)
 * - glosas = l√≠neas descriptivas con monto
 */
model Cotizacion {
  id     String @id @default(cuid())
  numero Int    @unique @default(autoincrement())

  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  proyecto_id String?
  proyecto    Proyecto? @relation(fields: [proyecto_id], references: [id], onDelete: SetNull)

  cliente_id String
  cliente    Cliente @relation(fields: [cliente_id], references: [id], onDelete: Restrict)

  // ‚úÖ temporalmente opcional
  vendedor_id String?
  vendedor    Usuario? @relation("CotizacionVendedor", fields: [vendedor_id], references: [id], onDelete: Restrict)

  asunto String?

    vigencia_dias Int @default(15)


  subtotal             Float   @default(0)
  iva                  Float   @default(0)
  total                Float   @default(0)
  terminos_condiciones String?
  acuerdo_pago         String?

  creada_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  estado EstadoCotizacion @default(COTIZACION)

  glosas CotizacionGlosa[]

  ventas  Venta[]
  compras Compra[]

  @@index([empresa_id])
  @@index([proyecto_id])
  @@index([cliente_id])
  @@index([vendedor_id])
}

/**
 * Glosa:
 * - descripcion: texto que ver√° el cliente ("Desarrollo sistema web")
 * - monto: monto asignado a esa glosa
 * - manual: true si el usuario la edit√≥ manualmente
 * - orden: para mantener el orden en UI/PDF
 */
model CotizacionGlosa {
  id            String     @id @default(cuid())
  cotizacion_id String
  cotizacion    Cotizacion @relation(fields: [cotizacion_id], references: [id], onDelete: Cascade)

  descripcion String
  monto       Float   @default(0)
  manual      Boolean @default(false)
  orden       Int     @default(0)

  @@index([cotizacion_id])
}

/**
 * OPCIONAL (si quieres mantener el modelo antiguo para cotizar productos/servicios):
 * Si NO lo vas a usar, b√≥rralo. Si lo mantienes, no lo uses para "glosas".
 * enum cotizacionItemTipo {
 * PRODUCTO
 * SERVICIO
 * }
 * model CotizacionItem {
 * id            String     @id @default(cuid())
 * cotizacion_id String
 * cotizacion    Cotizacion @relation(fields: [cotizacion_id], references: [id], onDelete: Cascade)
 * tipo          cotizacionItemTipo
 * producto_id    String?
 * producto       Producto? @relation(fields: [producto_id], references: [id], onDelete: SetNull)
 * item           String?
 * descripcion    String?
 * cantidad       Int
 * precioUnitario Float
 * total          Float
 * @@index([cotizacion_id])
 * }
 */

/**
 * =========================
 * VENTAS
 * =========================
 */
enum DetalleVentaModo {
  HH
  COMPRA
}

model Venta {
  id           String         @id @default(cuid())
  numero       Int            @unique @default(autoincrement())
  fecha        DateTime       @default(now())
  ordenVentaId String?
  descripcion  String?
  ordenVenta   Cotizacion?    @relation(fields: [ordenVentaId], references: [id], onDelete: Cascade)
  detalles     detalleVenta[]

  createdAt DateTime @default(now())
}

model detalleVenta {
  id String @id @default(cuid())

  ventaId     String
  descripcion String
  cantidad    Int
  total       Float
  fecha       DateTime @default(now())

  modo DetalleVentaModo @default(HH)

  tipoItemId String?

  compraId      String?
  costoUnitario Float?
  costoTotal    Float?

  empleadoId   String?
  hhEmpleadoId String?
  costoHH      Float?

  ventaUnitario      Float?
  ventaTotal         Float?
  utilidad           Float?
  porcentajeUtilidad Float?
  alpha              Float?

  tipoDiaId String?

  isFeriado   Boolean @default(false)
  isUrgencia  Boolean @default(false)
  isFinSemana Boolean @default(false)

  // ‚úÖ cat√°logos admin: SetNull para no romper hist√≥ricos
  tipoDia  TipoDia?  @relation(fields: [tipoDiaId], references: [id], onDelete: SetNull)
  tipoItem TipoItem? @relation(fields: [tipoItemId], references: [id], onDelete: SetNull)

  compras CompraItem? @relation(fields: [compraId], references: [id], onDelete: SetNull)

  venta Venta @relation(fields: [ventaId], references: [id], onDelete: Cascade)

  hhEmpleado HHEmpleado? @relation(fields: [hhEmpleadoId], references: [id], onDelete: SetNull)
  empleado   Empleado?   @relation(fields: [empleadoId], references: [id], onDelete: SetNull)

  @@index([ventaId])
  @@index([modo])
  @@index([tipoItemId])
  @@index([compraId])
  @@index([empleadoId])
  @@index([hhEmpleadoId])
}

/**
 * =========================
 * CAT√ÅLOGOS ADMIN (FK, no enum)
 * =========================
 */
model TipoDia {
  id         String  @id @default(cuid())
  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  nombre String
  valor  Float  @default(0)

  eliminado    Boolean   @default(false)
  eliminado_en DateTime?

  detalleVentas detalleVenta[]

  @@unique([empresa_id, nombre, eliminado])
  @@index([empresa_id])
}

model UnidadItem {
  id         String  @id @default(cuid())
  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  nombre String

  eliminado    Boolean   @default(false)
  eliminado_en DateTime?

  tipoItems TipoItem[]

  @@unique([empresa_id, nombre, eliminado])
  @@index([empresa_id])
}

model TipoItem {
  id         String  @id @default(cuid())
  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  nombre             String
  codigo             String? // "HH", "MATERIAL"... (recomendado)
  porcentajeUtilidad Float   @default(0)

  unidadItemId String?
  unidadItem   UnidadItem? @relation(fields: [unidadItemId], references: [id], onDelete: SetNull)

  eliminado    Boolean   @default(false)
  eliminado_en DateTime?

  ventas      detalleVenta[]
  compraItems CompraItem[]

  @@unique([empresa_id, codigo, eliminado])
  @@unique([empresa_id, nombre, eliminado])
  @@index([empresa_id])
  @@index([unidadItemId])
}

/**
 * =========================
 * COMPRAS
 * =========================
 */
enum estadoCompra {
  ORDEN_COMPRA
  FACTURADA
  PAGADA
}

model Compra {
  id          String    @id @default(cuid())
  numero      Int       @unique @default(autoincrement())
  empresa_id  String
  empresa     Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  proyecto_id String?
  proyecto    Proyecto? @relation(fields: [proyecto_id], references: [id], onDelete: Cascade)

  estado         estadoCompra @default(ORDEN_COMPRA)
  total          Float
  creada_en      DateTime     @default(now())
  actualizado_en DateTime     @updatedAt
  eliminado      Boolean      @default(false)
  eliminado_en   DateTime?

  cotizacionId String?
  cotizacion   Cotizacion?  @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  items        CompraItem[]

  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])
  proveedorId String?

  // === RCV (opcionales)
  tipo_doc        Int?
  folio           String?   @db.VarChar(50)
  rut_proveedor   String?   @db.VarChar(40)
  razon_social    String?   @db.VarChar(255)
  fecha_docto     DateTime?
  fecha_recepcion DateTime?

  // ‚úÖ NUEVO: factura PDF (guardar archivo en local storage y aqu√≠ solo la URL/path)
  factura_url    String?
  factura_numero String?   @db.VarChar(50)
  factura_fecha  DateTime?
  factura_monto  Float?

  @@index([empresa_id])
  @@index([proyecto_id])
}

model CompraItem {
  id           String  @id @default(cuid())
  compra_id    String?
  producto_id  String?
  proveedor_id String?
  item         String?
  cantidad     Int
  precio_unit  Float?
  total        Float

  // categor√≠a (admin)
  tipoItemId String?
  tipoItem   TipoItem? @relation(fields: [tipoItemId], references: [id], onDelete: SetNull)

  detalleVentas detalleVenta[]

  compra    Compra?    @relation(fields: [compra_id], references: [id], onDelete: Cascade)
  producto  Producto?  @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  proveedor Proveedor? @relation(fields: [proveedor_id], references: [id], onDelete: Cascade)

  @@index([compra_id])
  @@index([tipoItemId])
}

/**
 * =========================
 * RENDICIONES
 * =========================
 */
model Rendicion {
  id          String   @id @default(cuid())
  empleado_id String
  empleado    Empleado @relation(fields: [empleado_id], references: [id], onDelete: Cascade)

  proyecto_id String
  proyecto    Proyecto @relation(fields: [proyecto_id], references: [id], onDelete: Cascade)

  descripcion    String
  monto_total    Float    @default(0)
  estado         String   @default("pendiente")
  creada_en      DateTime @default(now())
  actualizado_en DateTime @updatedAt

  revisada_por_id     String?
  revisada_por        Usuario?  @relation(fields: [revisada_por_id], references: [id], onDelete: SetNull)
  fecha_revision      DateTime?
  comentario_revision String?

  eliminado    Boolean   @default(false)
  eliminado_en DateTime?

  items RendicionItem[]

  @@index([proyecto_id])
  @@index([estado])
  @@index([revisada_por_id])
}

model RendicionItem {
  id           String    @id @default(cuid())
  rendicion_id String
  rendicion    Rendicion @relation(fields: [rendicion_id], references: [id], onDelete: Cascade)

  linea           Int
  fecha           DateTime
  descripcion     String
  monto           Float
  categoria       String?
  comprobante_url String?

  creado_en DateTime @default(now())

  @@unique([rendicion_id, linea])
  @@index([rendicion_id])
}

/**
 * =========================
 * AUDITOR√çA / HISTORIAL
 * =========================
 */
model AuditLog {
  id String @id @default(cuid())

  empresa_id String?
  empresa    Empresa? @relation(fields: [empresa_id], references: [id], onDelete: SetNull)

  usuario_id String?
  usuario    Usuario? @relation(fields: [usuario_id], references: [id], onDelete: SetNull)

  entidad     String
  registro_id String
  accion      String

  detalles   Json?
  ip         String?
  user_agent String?

  creado_en DateTime @default(now())

  @@index([empresa_id])
  @@index([usuario_id])
  @@index([entidad, registro_id])
  @@index([accion])
  @@index([creado_en])
}

/**
 * =========================
 * HH EMPLEADO
 * =========================
 */

model CIF {
  id String @id @default(cuid())

  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  // opcional: si quieres que el CIF ‚Äúaplique‚Äù a un periodo espec√≠fico
  anio Int?
  mes  Int?

  valor     Float    @default(0)
  nota      String? // ej: "CIF Enero", "Actualizaci√≥n arriendo", etc.
  creado_en DateTime @default(now())

  // relaci√≥n inversa
  hhempleados HHEmpleado[]

  @@index([empresa_id])
  @@index([empresa_id, creado_en])
  @@index([empresa_id, anio, mes])
}

model HHEmpleado {
  id String @id @default(cuid())

  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  empleado_id String?
  empleado    Empleado? @relation(fields: [empleado_id], references: [id], onDelete: SetNull)

  anio           Int
  mes            Int
  nombre_periodo String?

  nombre String?
  rut    String? @db.VarChar(40)

  dias_trabajados Int?

  sueldo_base   Float?
  extras        Float?
  gratificacion Float?

  imponible1   Float?
  imponible2   Float?
  movilizacion Float?
  colacion     Float?
  imponible3   Float?
  imponible4   Float?

  haberes Float?

  afp         Float?
  unico       Float?
  previsional Float?
  salud       Float?
  antiguo     Float?
  anticipos   Float?
  prestamos   Float?
  apv         Float?

  desctos1 Float?
  desctos2 Float?

  liquido   Float?
  empleador Float?

  pagado        Float?
  feriado       Float?
  indemnizacion Float?
  total         Float?
  costoHH       Float?

  horasMensuales Float?
  horasEfectivas Float?

  raw Json?

  cif_id String?
  cif    CIF?    @relation(fields: [cif_id], references: [id], onDelete: SetNull)

  creado_en      DateTime       @default(now())
  actualizado_en DateTime       @updatedAt
  ventas         detalleVenta[]

  @@index([empresa_id, anio, mes])
  @@index([empleado_id])
  @@index([rut])
}
