generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // o "mysql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * EMPRESA / ESTRUCTURA BASE
 * =========================
 */
model Empresa {
  id             String    @id @default(cuid())
  nombre         String
  rut            String?   @db.VarChar(40)
  correo         String?
  telefono       String?
  activa         Boolean   @default(true)
  creada_en      DateTime  @default(now())
  actualizada_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  usuarios    Usuario[]
  clientes    Cliente[]
  proveedores Proveedor[]
  productos   Producto[]
  proyectos   Proyecto[]
  Cotizacion  Cotizacion[]
  Compra      Compra[]
  auditLogs   AuditLog[]

  // üëá previsi√≥n
  afpConfigs   AFPConfig[]
  saludConfigs SaludConfig[]

  // üëá HH por empleado (resultado del Excel + c√°lculos)
  hhEmpleados HHEmpleado[]
}

/**
 * =========================
 * ROLES DE USUARIO
 * =========================
 */
model RolUsuario {
  id             String    @id @default(cuid())
  nombre         String    @unique
  codigo         String?   @unique
  descripcion    String?
  orden          Int?
  activo         Boolean   @default(true)
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  usuarios Usuario[]
}

/**
 * =========================
 * USUARIOS / RRHH
 * =========================
 */
model Usuario {
  id         String     @id @default(cuid())
  empresa_id String
  empresa    Empresa    @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  rol_id     String
  rol        RolUsuario @relation(fields: [rol_id], references: [id], onDelete: Cascade)

  nombre     String
  correo     String
  contrasena String

  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  empleado              Empleado?
  rendiciones_revisadas Rendicion[]
  auditLogs             AuditLog[]

  @@unique([correo, eliminado])
}

model Empleado {
  id         String   @id @default(cuid())
  usuario_id String?  @unique
  usuario    Usuario? @relation(fields: [usuario_id], references: [id], onDelete: SetNull)

  // üëá para matchear con Excel
  rut String? @db.VarChar(40)

  cargo          String?
  telefono       String?
  fecha_ingreso  DateTime?
  sueldo_base    Int?
  activo         Boolean   @default(true)
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  // previsi√≥n
  afp_id String?
  afp    AFPConfig? @relation(fields: [afp_id], references: [id], onDelete: SetNull)

  salud_id String?
  salud    SaludConfig? @relation(fields: [salud_id], references: [id], onDelete: SetNull)

  Rendicion Rendicion[]
  proyectos ProyectoMiembro[]

  // Responsable principal de tareas
  tareas Tarea[]

  // Responsable de subtareas
  detalles TareaDetalle[] @relation("EmpleadoTareaDetalle")

  // üëá HH ya calculadas por periodo (derivado del Excel)
  hhRegistros   HHEmpleado[]
  detalleVentas detalleVenta[]

  @@index([afp_id])
  @@index([salud_id])
}

model AFPConfig {
  id         String  @id @default(cuid())
  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  nombre String // Ej: "AFP Habitat"
  codigo String? @unique // Ej: "HABITAT"
  tasa   Float // Ej: 0.114 (11,4%)

  activo         Boolean  @default(true)
  creado_en      DateTime @default(now())
  actualizado_en DateTime @updatedAt

  empleados Empleado[]

  @@index([empresa_id])
}

model SaludConfig {
  id         String  @id @default(cuid())
  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  tipo   String // "FONASA" | "ISAPRE"
  nombre String // Ej: "Fonasa", "Colmena"
  tasa   Float // Ej: 0.07 (7% base) o equivalente plan

  activo         Boolean  @default(true)
  creado_en      DateTime @default(now())
  actualizado_en DateTime @updatedAt

  empleados Empleado[]

  @@index([empresa_id])
}

/**
 * =========================
 * CLIENTES / PROVEEDORES
 * =========================
 */
model Cliente {
  id             String    @id @default(cuid())
  empresa_id     String
  empresa        Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  nombre         String
  rut            String?   @db.VarChar(40)
  correo         String?
  telefono       String?
  notas          String?
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  cotizaciones Cotizacion[]

  @@unique([correo, eliminado])
  @@index([empresa_id])
}

model Proveedor {
  id             String    @id @default(cuid())
  empresa_id     String
  empresa        Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  nombre         String
  rut            String?   @db.VarChar(40)
  correo         String?
  telefono       String?
  notas          String?
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  compras     Compra[]
  compraItems CompraItem[]

  @@unique([correo, eliminado])
  @@index([empresa_id])
}

/**
 * =========================
 * PRODUCTOS
 * =========================
 */
model Producto {
  id             String    @id @default(cuid())
  empresa_id     String
  empresa        Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  nombre         String
  sku            String?
  precio         Float
  stock          Int       @default(0)
  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  cotizaciones CotizacionItem[]
  compras      CompraItem[]

  @@unique([sku, eliminado])
  @@index([empresa_id])
}

/**
 * =========================
 * PROYECTOS
 * =========================
 */
model Proyecto {
  id             String    @id @default(cuid())
  empresa_id     String
  empresa        Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  nombre         String
  descripcion    String?
  presupuesto    Float? //aqui se deber√≠a hacer segun la asignacion de tareas y sus costos
  estado         String    @default("activo")
  creada_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  // soft delete
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  cotizaciones Cotizacion[]
  compras      Compra[]
  rendiciones  Rendicion[]

  tareas   Tarea[]
  miembros ProyectoMiembro[]

  @@index([empresa_id])
}

model ProyectoMiembro {
  id          String   @id @default(cuid())
  proyecto_id String
  empleado_id String
  rol         String?
  creado_en   DateTime @default(now())

  proyecto Proyecto @relation(fields: [proyecto_id], references: [id], onDelete: Cascade)
  empleado Empleado @relation(fields: [empleado_id], references: [id], onDelete: Cascade)

  @@unique([proyecto_id, empleado_id])
  @@index([empleado_id])
}

/**
 * =========================
 * TAREAS (Planificaci√≥n/Gantt)
 * =========================
 */
model Tarea {
  id          String   @id @default(cuid())
  proyecto_id String
  proyecto    Proyecto @relation(fields: [proyecto_id], references: [id], onDelete: Cascade)

  nombre         String
  descripcion    String?
  responsable_id String?
  responsable    Empleado? @relation(fields: [responsable_id], references: [id], onDelete: SetNull)

  prioridad Int?
  estado    String  @default("pendiente")
  avance    Int     @default(0)
  es_hito   Boolean @default(false)
  orden     Int?

  // base del Gantt
  fecha_inicio_plan DateTime
  fecha_fin_plan    DateTime
  dias_plan         Int?

  fecha_inicio_real DateTime?
  fecha_fin_real    DateTime?
  dias_reales       Int?

  // Totales agregados desde los detalles
  total_dias_plan    Int?
  total_dias_reales  Int?
  total_horas_plan   Float?
  total_horas_reales Float?
  total_costo_plan   Float?
  total_costo_real   Float?
  total_responsables Int? // cantidad de responsables distintos en subtareas

  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  dependencias TareaDependencia[] @relation("TareaDependencias")
  sucesoras    TareaDependencia[] @relation("TareaPredecesoras")

  // Subtareas / Detalles
  detalles TareaDetalle[]

  dias_desviacion Int?

  @@index([proyecto_id])
  @@index([responsable_id])
  @@index([estado])
}

model TareaDetalle {
  id       String @id @default(cuid())
  tarea_id String
  tarea    Tarea  @relation(fields: [tarea_id], references: [id], onDelete: Cascade)

  // info principal
  titulo      String
  descripcion String?

  // responsable √öNICO de la subtarea
  responsable_id String?
  responsable    Empleado? @relation("EmpleadoTareaDetalle", fields: [responsable_id], references: [id], onDelete: SetNull)

  estado String @default("pendiente") // pendiente | en_progreso | completada
  avance Int    @default(0) // opcional, de momento usamos estado

  // PLANIFICADO
  fecha_inicio_plan DateTime
  fecha_fin_plan    DateTime
  dias_plan         Int // se calcula en backend

  // REAL
  fecha_inicio_real DateTime?
  fecha_fin_real    DateTime?
  dias_reales       Int?

  // TIEMPO Y COSTOS (HH)
  horas_plan Float?
  horas_real Float?

  valor_hora Float?
  costo_plan Float?
  costo_real Float?

  dias_desviacion Int?

  creado_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?
}

model TareaDependencia {
  id             String  @id @default(cuid())
  tarea_id       String
  predecesora_id String
  tipo           String? // "FS"

  tarea       Tarea @relation("TareaDependencias", fields: [tarea_id], references: [id], onDelete: Cascade)
  predecesora Tarea @relation("TareaPredecesoras", fields: [predecesora_id], references: [id], onDelete: Cascade)

  @@unique([tarea_id, predecesora_id])
  @@index([predecesora_id])
}

enum EstadoCotizacion {
  COTIZACION
  ORDEN_VENTA
  FACTURADA
  PAGADA
}

model Cotizacion {
  id             String    @id @default(cuid())
  numero         Int       @unique @default(autoincrement())
  empresa_id     String
  empresa        Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  proyecto_id    String
  proyecto       Proyecto  @relation(fields: [proyecto_id], references: [id], onDelete: Cascade)
  cliente_id     String?
  cliente        Cliente?  @relation(fields: [cliente_id], references: [id], onDelete: Cascade)

  descripcion    String?

  // ‚úÖ NUEVO (para cotizaci√≥n cliente)
  cantidad             Int?     // ‚Äúcantidad‚Äù del documento (si aplica)
  subtotal             Float    @default(0)
  iva                  Float    @default(0)
  total                Float    @default(0)
  terminos_condiciones String?
  acuerdo_pago         String?

  creada_en      DateTime  @default(now())
  actualizado_en DateTime  @updatedAt
  eliminado      Boolean   @default(false)
  eliminado_en   DateTime?

  estado  EstadoCotizacion @default(COTIZACION)
  items   CotizacionItem[]
  ventas  Venta[]
  compras Compra[]

  @@index([empresa_id])
  @@index([proyecto_id])
}


model CotizacionItem {
  id            String     @id @default(cuid())
  cotizacion_id String
  cotizacion    Cotizacion @relation(fields: [cotizacion_id], references: [id], onDelete: Cascade)

  tipo cotizacionItemTipo

  //si es un producto se selecciona esto, sino es un texto libre para escribir el nomrbe de producto o servicio
  producto_id    String?
  producto       Producto? @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  Item           String?
  descripcion    String?
  cantidad       Int
  precioUnitario Float
  total          Float

  @@index([cotizacion_id])
}

enum cotizacionItemTipo {
  PRODUCTO
  SERVICIO
}

//listo
//listo
//listo
model Venta {
  id           String         @id @default(cuid())
  numero       Int            @unique @default(autoincrement())
  fecha        DateTime       @default(now())
  ordenVentaId String?
  descripcion  String?
  ordenVenta   Cotizacion?    @relation(fields: [ordenVentaId], references: [id], onDelete: Cascade)
  detalles     detalleVenta[]

  createdAt DateTime @default(now())
}

model detalleVenta {
  id          String   @id @default(cuid())
  //obligatorios
  ventaId     String
  descripcion String
  cantidad    Int
  costoTotal  Float?
  fecha       DateTime @default(now())
  tipoItemId  String?

  //opcional si es empleado (HH) o si es producto (detalleVenta)
  compraId           String?
  costoHH            Float?
  costoUnitario      Float?
  ventaUnitario      Float?
  ventaTotal         Float?
  utilidad           Float?
  porcentajeUtilidad Float?
  alpha              Float?
  empleadoId         String?
  hhEmpleadoId       String?
  total              Float

  tipoDiaId String?

  //validar que d√≠a es, si es fin de semana, feriado o urgencia
  isFeriado   Boolean @default(false)
  isUrgencia  Boolean @default(false)
  isFinSemana Boolean @default(false)

  tipoDia    tipoDia?    @relation(fields: [tipoDiaId], references: [id], onDelete: Cascade)
  tipoItem   tipoItem?   @relation(fields: [tipoItemId], references: [id], onDelete: Cascade)
  compras    CompraItem? @relation(fields: [compraId], references: [id], onDelete: Cascade)
  venta      Venta       @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  hhEmpleado HHEmpleado? @relation(fields: [hhEmpleadoId], references: [id], onDelete: Cascade)
  empleado   Empleado?   @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  @@index([ventaId])
}

model tipoDia {
  id     String @id @default(cuid())
  nombre String //feriado , fds, urgencia, normal
  valor  Float

  detalleVentas detalleVenta[]
}

//listo
//listo
model tipoItem {
  id                 String         @id @default(cuid())
  nombre             String
  porcentajeUtilidad Float
  unidadItemId       String?
  unidadItem         unidadItem?    @relation(fields: [unidadItemId], references: [id], onDelete: Cascade)
  ventas             detalleVenta[]
}

model unidadItem {
  id        String     @id @default(cuid())
  nombre    String
  tipoItems tipoItem[]
}

enum estadoCompra {
  ORDEN_COMPRA
  FACTURADA
  PAGADA
}

model Compra {
  id          String    @id @default(cuid())
  numero      Int       @unique @default(autoincrement())
  empresa_id  String
  empresa     Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  proyecto_id String?
  proyecto    Proyecto? @relation(fields: [proyecto_id], references: [id], onDelete: Cascade)

  estado         estadoCompra @default(ORDEN_COMPRA)
  total          Float
  creada_en      DateTime     @default(now())
  actualizado_en DateTime     @updatedAt
  // soft delete
  eliminado      Boolean      @default(false)
  eliminado_en   DateTime?

  cotizacionId String?
  cotizacion   Cotizacion?  @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  items        CompraItem[]

  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])
  proveedorId String?

   // === Datos para importaci√≥n RCV (opcionales) ===
  tipo_doc        Int?
  folio           String?    @db.VarChar(50)
  rut_proveedor   String?    @db.VarChar(40)
  razon_social    String?    @db.VarChar(255)
  fecha_docto     DateTime?
  fecha_recepcion DateTime?

  @@index([empresa_id])
  @@index([proyecto_id])
}

model CompraItem {
  id           String  @id @default(cuid())
  compra_id    String?
  producto_id  String?
  proveedor_id String?
  item         String?
  cantidad     Int
  precio_unit  Float?
  total        Float

  detalleVentas detalleVenta[]

  compra    Compra?    @relation(fields: [compra_id], references: [id], onDelete: Cascade)
  producto  Producto?  @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  proveedor Proveedor? @relation(fields: [proveedor_id], references: [id], onDelete: Cascade)

  @@index([compra_id])
}

/**
 * =========================
 * RENDICIONES
 * =========================
 */
model Rendicion {
  id          String   @id @default(cuid())
  empleado_id String
  empleado    Empleado @relation(fields: [empleado_id], references: [id], onDelete: Cascade)

  proyecto_id String
  proyecto    Proyecto @relation(fields: [proyecto_id], references: [id], onDelete: Cascade)

  descripcion    String
  monto_total    Float    @default(0)
  estado         String   @default("pendiente") // "pendiente" | "aprobada" | "rechazada"
  creada_en      DateTime @default(now())
  actualizado_en DateTime @updatedAt

  // revisi√≥n / aprobaci√≥n
  revisada_por_id     String?
  revisada_por        Usuario?  @relation(fields: [revisada_por_id], references: [id], onDelete: SetNull)
  fecha_revision      DateTime?
  comentario_revision String?

  // soft delete
  eliminado    Boolean   @default(false)
  eliminado_en DateTime?

  items RendicionItem[]

  @@index([proyecto_id])
  @@index([estado])
  @@index([revisada_por_id])
}

model RendicionItem {
  id           String    @id @default(cuid())
  rendicion_id String
  rendicion    Rendicion @relation(fields: [rendicion_id], references: [id], onDelete: Cascade)

  linea           Int
  fecha           DateTime
  descripcion     String
  monto           Float
  categoria       String?
  comprobante_url String?

  creado_en DateTime @default(now())

  @@unique([rendicion_id, linea])
  @@index([rendicion_id])
}

/**
 * =========================
 * AUDITOR√çA / HISTORIAL
 * =========================
 */
model AuditLog {
  id String @id @default(cuid())

  empresa_id String?
  empresa    Empresa? @relation(fields: [empresa_id], references: [id], onDelete: SetNull)

  usuario_id String?
  usuario    Usuario? @relation(fields: [usuario_id], references: [id], onDelete: SetNull)

  entidad     String
  registro_id String
  accion      String

  detalles   Json?
  ip         String?
  user_agent String?

  creado_en DateTime @default(now())

  @@index([empresa_id])
  @@index([usuario_id])
  @@index([entidad, registro_id])
  @@index([accion])
  @@index([creado_en])
}

model HHEmpleado {
  id String @id @default(cuid())

  empresa_id String
  empresa    Empresa @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  empleado_id String?
  empleado    Empleado? @relation(fields: [empleado_id], references: [id], onDelete: SetNull)

  // Per√≠odo
  anio           Int
  mes            Int
  nombre_periodo String? // ej: "Noviembre 2025"

  // Identificaci√≥n seg√∫n Excel
  nombre String? // "Nombre"
  rut    String? @db.VarChar(40) // "RUT"

  // ============================
  // COLUMNAS BASE DEL EXCEL
  // ============================
  // Trab. = d√≠as trabajados
  dias_trabajados Int? // "Trab."

  sueldo_base   Float? // "Sueldo Base"
  extras        Float? // "Extras"
  gratificacion Float? // "Gratific."

  // En tu Excel hay varias columnas llamadas "Imponible"
  imponible1   Float? // primer "Imponible"
  imponible2   Float? // segundo "Imponible"
  movilizacion Float? // "Moviliz."
  colacion     Float? // "Colac."
  imponible3   Float? // tercer "Imponible"
  imponible4   Float? // cuarto "Imponible"

  haberes Float? // "Haberes"

  afp         Float? // "AFP"
  unico       Float? // "√önico"
  previsional Float? // "Previsional"
  salud       Float? // "Salud"
  antiguo     Float? // "Antiguo"
  anticipos   Float? // "Anticipos"
  prestamos   Float? // "Prestamos"
  apv         Float? // "APV"

  desctos1 Float? // "Desctos." (1)
  desctos2 Float? // "Desctos." (2)

  liquido   Float? // "L√≠quido"
  empleador Float?

  //--------------
  //calcular
  pagado         Float?
  feriado        Float?
  indemnizacion  Float?
  total          Float?
  costoHH        Float?
  cif            Float?
  horasMensuales Float?
  horasEfectivas Float?

  // fila original por si quieres guardar todo crudo del Excel
  raw Json?

  creado_en      DateTime       @default(now())
  actualizado_en DateTime       @updatedAt
  ventas         detalleVenta[]

  @@index([empresa_id, anio, mes])
  @@index([empleado_id])
  @@index([rut])
}
